<%- include('partials/header') %> <!-- Assuming you have a header partial -->

<style>
    /* Keeping your specific layout styles */
    :root {
        --black: #0a0a0a; --dark-gray: #1a1a1a; --white: #ffffff;
        --gold: #FFD700; --silver: #c0c0c0; --glow-gold: rgba(255, 215, 0, 0.5);
        --light-gray: #3a3a3a;
    }
    .download-layout { display: grid; grid-template-columns: 300px 1fr; gap: 40px; margin-top: 40px; }
    .info-panel { background-color: var(--dark-gray); padding: 30px; border-radius: 15px; text-align: center; align-self: flex-start; }
    .app-icon { width: 120px; height: 120px; border-radius: 25px; margin: 0 auto 20px auto; object-fit: cover; display: block; }
    .rating { display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 20px; }
    .stars-outer { position: relative; display: inline-block; font-size: 1.2em; letter-spacing: 2px; }
    .stars-inner { position: absolute; top: 0; left: 0; white-space: nowrap; overflow: hidden; width: 0; }
    .stars-outer::before { content: "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ"; color: #555; }
    .stars-inner::before { content: "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ"; color: var(--gold); }
    
    .download-button { display: block; background: var(--gold); color: var(--black); padding: 18px 20px; border-radius: 10px; text-decoration: none; font-size: 1.3em; font-weight: 700; margin-bottom: 15px; transition: 0.3s; box-shadow: 0 0 15px var(--glow-gold); }
    .download-button:hover { transform: translateY(-5px); }
    
    .action-buttons { display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
    .full-width-btn { width: 100%; border: 1px solid #444; background: transparent; color: var(--silver); padding: 10px; border-radius: 8px; cursor: pointer; }
    
    .details-panel { background-color: var(--dark-gray); padding: 30px; border-radius: 15px; }
    .tabs-nav { display: flex; border-bottom: 2px solid #2a2a2a; margin-bottom: 25px; }
    .tab-button { background: none; border: none; color: var(--silver); padding: 15px 25px; cursor: pointer; }
    .tab-button.active { color: var(--gold); border-bottom: 2px solid var(--gold); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .screenshot-gallery { column-count: 3; column-gap: 15px; }
    .screenshot-gallery img { width: 100%; border-radius: 10px; margin-bottom: 15px; }
    
    /* Meta Info List */
    .meta-info { list-style: none; text-align: left; color: var(--silver); }
    .meta-info li { padding: 10px 0; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; }
    
    @media (max-width: 992px) { .download-layout { grid-template-columns: 1fr; } }
</style>

<main class="container">
    <div class="download-layout">
        <!-- Left Info Panel -->
        <aside class="info-panel">
            <img src="<%= file.iconUrl %>" alt="<%= file.name %>" class="app-icon">
            <h1><%= file.name %></h1>
            
            <div class="rating">
                <div class="stars-outer">
                    <div class="stars-inner" style="width: <%= (file.averageRating / 5) * 100 %>%;"></div>
                </div>
                <span class="rating-text"><%= file.averageRating.toFixed(1) %></span>
            </div>

            <% if (file.certification === 'certified') { %>
            <div class="safety-badge">
                <span class="badge-icon">üõ°Ô∏è</span>
                <span class="badge-text">100% Safe & Tested</span>
            </div>
            <% } %>
            
            <a href="/download-file/<%= file._id %>" class="download-button">
                Download APK (<%= (file.fileSize / (1024 * 1024)).toFixed(1) %> MB)
            </a>
            
            <div class="action-buttons">
                <% if (user) { %>
                    <form action="/files/<%= file._id %>/wishlist" method="POST">
                        <button type="submit" class="full-width-btn">
                            <%= userHasWhitelisted ? '‚ù§Ô∏è In Wishlist' : 'ü§ç Add to Wishlist' %>
                        </button>
                    </form>
                <% } %>
                <button class="full-width-btn">‚öë Report File</button>
            </div>

            <ul class="meta-info">
                <li>Version: <span><%= file.version %></span></li>
                <li>Category: <span><%= file.category %></span></li>
                <li>Developer: <span class="gold"><%= file.developer %></span></li>
                <li>Downloads: <span><%= file.downloads.toLocaleString() %></span></li>
                <li>Updated: <span><%= new Date(file.updatedAt).toLocaleDateString() %></span></li>
                <li>Working?: 
                    <span class="gold">
                        <% let total = file.workingVoteCount + file.notWorkingVoteCount; %>
                        <%= total > 0 ? Math.round((file.workingVoteCount / total) * 100) : 0 %>%
                    </span>
                </li>
            </ul>
        </aside>

        <!-- Right Details Panel -->
        <section class="details-panel">
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="description">Description</button>
                <button class="tab-button" data-tab="screenshots">Screenshots</button>
                <button class="tab-button" data-tab="versions">Versions</button>
                <button class="tab-button" data-tab="comments">Comments</button>
            </div>

            <!-- Tab: Description -->
            <div id="description" class="tab-content active">
                <div class="info-box silver">
                    <h2>What's New</h2>
                    <p><%- file.officialDescription ? file.officialDescription.replace(/\n/g, '<br>') : 'No recent update notes.' %></p>
                </div>

                <div class="info-box gold">
                    <h2>Mod Information</h2>
                    <p><%- file.modDescription ? file.modDescription.replace(/\n/g, '<br>') : 'No mod info provided.' %></p>
                </div>
            </div>

            <!-- Tab: Screenshots -->
            <div id="screenshots" class="tab-content">
                <div class="screenshot-gallery">
                    <% if (file.screenshotUrls && file.screenshotUrls.length > 0) { %>
                        <% file.screenshotUrls.forEach(url => { %>
                            <img src="<%= url %>" alt="Screenshot">
                        <% }) %>
                    <% } else { %>
                        <p>No screenshots available.</p>
                    <% } %>
                </div>
            </div>
            
            <!-- Tab: Versions -->
            <div id="versions" class="tab-content">
                <table class="versions-table" style="width:100%; text-align:left;">
                    <thead>
                        <tr style="color:var(--gold)">
                            <th>Version</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% versionHistory.forEach(v => { %>
                        <tr>
                            <td><%= v.version %></td>
                            <td><%= new Date(v.createdAt).toLocaleDateString() %></td>
                            <td><a href="/download-file/<%= v._id %>" style="color:var(--gold)">Download</a></td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

            <!-- Tab: Comments -->
            <div id="comments" class="tab-content">
                <% if (user) { %>
                    <div class="comment-form">
                        <h3>Leave a Review</h3>
                        <form action="/reviews/add/<%= file._id %>" method="POST">
                            <textarea name="comment" placeholder="Share your experience..." required style="width:100%; height:100px; background:#222; color:white; border-radius:8px; padding:10px;"></textarea>
                            <button type="submit" class="download-button" style="margin-top:10px; cursor:pointer;">Post Comment</button>
                        </form>
                    </div>
                <% } %>

                <div class="comment-list">
                    <% reviews.forEach(review => { %>
                    <div class="comment-item" style="background:#111; padding:15px; border-radius:10px; margin-top:15px;">
                        <div class="comment-header" style="display:flex; justify-content:space-between;">
                            <strong><%= review.username %></strong>
                            <span class="gold">‚òÖ <%= review.rating %></span>
                        </div>
                        <p style="color:var(--silver); margin-top:10px;"><%= review.comment %></p>
                    </div>
                    <% }) %>
                </div>
            </div>
        </section>
    </div>
</main>

<script>
    // Simple Tab Switcher Logic
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            const target = button.getAttribute('data-tab');
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            button.classList.add('active');
            document.getElementById(target).classList.add('active');
        });
    });
</script>

<%- include('partials/footer') %>