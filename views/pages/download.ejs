<%- include('../partials/header') %>

<main class="container">
    <div class="download-layout">
        <!-- Left Info Panel -->
        <aside class="info-panel">
            <img src="<%= file.iconUrl %>" alt="<%= file.name %> Icon" class="app-icon">
            <h1><%= file.name %></h1>
            
            <div class="rating">
                <div class="stars-outer">
                    <div class="stars-inner" style="width: <%= (file.averageRating / 5) * 100 %>%;"></div>
                </div>
                <span class="rating-text"><%= file.averageRating.toFixed(1) %></span>
            </div>

            <% if (file.certification === 'certified') { %>
            <div class="safety-badge">
                <span class="badge-icon">üõ°Ô∏è</span>
                <span class="badge-text">100% Safe & Admin Certified</span>
            </div>
            <% } %>
            
            <a href="/download-file/<%= file._id %>" class="download-button">
                Download (<%= (file.fileSize / (1024 * 1024)).toFixed(1) %> MB)
            </a>
            
            <div class="action-buttons">
    
                <!-- This row will contain Wishlist and Report -->
                <div class="action-row">
                    <% if (user) { %>
                        <!-- Wishlist Form -->
                        <form action="/files/<%= file._id %>/whitelist" method="POST" style="flex: 1; margin:0; display: contents;">
                            <button type="submit" style="flex: 1; text-align: center; text-decoration: none; padding: 10px; border-radius: 8px; background-color: #2a2a2a; color: var(--silver); font-weight: 600; transition: all 0.3s ease; border:none; cursor:pointer; font-family: 'Poppins'; font-size: 1em;">
                                <%= userHasWhitelisted ? '‚ù§ In Wishlist' : '‚ù§ Add to Wishlist' %>
                            </button>
                        </form>

                        <!-- Report Button -->
                        <button type="button" id="reportModalBtn" style="flex: 1; text-align: center; text-decoration: none; padding: 10px; border-radius: 8px; background-color: #2a2a2a; color: var(--silver); font-weight: 600; transition: all 0.3s ease; border:none; cursor:pointer; font-family: 'Poppins'; font-size: 1em;">
                            ‚öë Report
                        </button>
                    <% } else { %>
                        <a href="/login" class="full-width-btn">Login to Wishlist or Report</a>
                    <% } %>
                </div>

                <!-- The rest of the buttons follow, each on its own line -->
                <% if (file.virusTotalAnalysisId) { %>
                    <a href="https://www.virustotal.com/gui/file-analysis/<%= file.virusTotalAnalysisId %>" target="_blank" class="full-width-btn">Check File Safety Status</a>
                <% } %>
                
                <!-- Add these lines for debugging. You can remove them later. -->
                <!-- 
                    DEBUG:
                    Logged in as: <%= user ? user.username : 'Not Logged In' %>
                    File Uploader: <%= file.uploader %>
                    Do they match?: <%= user && user.username.toLowerCase() === file.uploader.toLowerCase() %>
                -->

                <% if (user && user.username.toLowerCase() === file.uploader.toLowerCase()) { %>
                    <a href="/mods/<%= file._id %>/add-version" class="full-width-btn">Ôºã Add New Version</a>
                <% } %>

            </div>
            <ul class="meta-info">
    <li>Version: <span><%= file.version %></span></li>
    <li>Category: <span><%= file.platforms[0] || 'N/A' %></span></li>

    <li> <!-- Developer LI -->
        Developer: 
        <% if (file.developer && file.developer !== 'N/A') { %>
            <a href="/developer?name=<%= encodeURIComponent(file.developer) %>" class="meta-link">
                <%= file.developer %> <span class="arrow">‚Ä∫</span>
            </a>
        <% } else { %>
            <span>N/A</span>
        <% } %>
    </li> <!-- CORRECTLY CLOSED -->

    <li> <!-- Uploader LI -->
        Uploaded by: 
        <a href="/users/<%= file.uploader %>" class="meta-link">
            <%= file.uploader %> <span class="arrow">‚Ä∫</span>
        </a>
    </li> <!-- CORRECTLY CLOSED -->

    <li>Downloads: <span><%= file.downloads.toLocaleString() %></span></li>
    <li>Updated: <span><%= new Date(file.updatedAt).toLocaleDateString() %></span></li>
    
    <li>Working?:
        <% const totalVotes = file.workingVoteCount + file.notWorkingVoteCount; %>
        <% const workingPercentage = totalVotes > 0 ? Math.round((file.workingVoteCount / totalVotes) * 100) : 0; %>
        <div class="voting-system">
            <span class="working-percentage"><%= workingPercentage %>%</span>
            <% if(user && !userHasVotedOnStatus) { %>
            <div class="vote-buttons">
                <form action="/files/<%= file._id %>/vote-status" method="POST" style="margin:0;"><input type="hidden" name="voteType" value="working"><button title="It works!">‚úì</button></form>
                <form action="/files/<%= file._id %>/vote-status" method="POST" style="margin:0;"><input type="hidden" name="voteType" value="not-working"><button title="It doesn't work!">X</button></form>
            </div>
            <% } %>
        </div>
    </li>
</ul>
        </aside>

        <!-- Right Details Panel -->
        <section class="details-panel">
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="description">Description</button>
                <button class="tab-button" data-tab="screenshots">Screenshots</button>
                <button class="tab-button" data-tab="versions">Versions</button>
                <button class="tab-button" data-tab="comments">Comments</button>
            </div>

            <div id="description" class="tab-content active">
                <!-- What's New Section (pulls from the new 'whatsNew' field) -->
                <% if (file.whatsNew) { %>
                <div class="info-box silver">
                    <h2>What's New</h2>
                    <p><%- file.whatsNew.replace(/\n/g, '<br>') %></p>
                </div>
                <% } %>

                <!-- Mod Information (pulls from 'modDescription') -->
                <div class="info-box gold">
    <h2>Mod Information</h2>
    <!-- The general description still shows first -->
    <p><%- file.modDescription.replace(/\n/g, '<br>') %></p>

    <!-- ======== ADD THIS NEW FEATURES LIST LOGIC ======== -->
    <% if (file.modFeatures) { %>
        <div class="features-list-container">
            <ul class="features-list">
                <% 
                // 1. Split the modFeatures string into an array, one item per line
                const features = file.modFeatures.split(/\r?\n/);

                // 2. Loop through each feature line
                features.forEach(feature => {
                    if (feature.trim() !== '') { // Ignore empty lines
                        // 3. Split each line by the first colon ':' to separate title and description
                        const parts = feature.split(/:(.*)/s);
                        const title = parts[0].trim();
                        const description = parts.length > 1 ? parts[1].trim() : '';
                %>
                        <li>
                            <span class="feature-icon">‚úì</span>
                            <div class="feature-text">
                                <strong><%= title %>:</strong>
                                <% if (description) { %>
                                    <span><%= description %></span>
                                <% } %>
                            </div>
                        </li>
                <%
                    }
                });
                %>
            </ul>
        </div>
    <% } %>
    <!-- ================================================ -->
</div>
            
            <div id="screenshots" class="tab-content">
                <h2>Screenshots</h2>
                <div class="screenshot-gallery">
                    <% file.screenshotUrls.forEach(url => { %>
                        <img src="<%= url %>" alt="Screenshot of <%= file.name %>">
                    <% }) %>
                </div>
            </div>
            
            <div id="versions" class="tab-content">
                <h2>Version History</h2>
                <table class="versions-table">
                    <thead><tr><th>Version</th><th>Date</th><th>Download</th></tr></thead>
                    <tbody>
                        <% versionHistory.forEach(version => { %>
                            <tr>
                                <td data-label="Version"><%= version.version %> <% if(version._id.equals(file._id)) { %>(Latest)<% } %></td>
                                <td data-label="Date"><%= new Date(version.createdAt).toLocaleDateString() %></td>
                                <td data-label="Link"><a href="/download-file/<%= version._id %>">Download</a></td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

            <div id="comments" class="tab-content">
                <h2>Community Comments</h2>
                <% if (user) { %>
                <div class="comment-form">
                    <h3>Leave a Review</h3>
                    <form action="/reviews/add/<%= file._id %>" method="POST">
                        <textarea name="comment" placeholder="Share your experience..." required></textarea>
                        <div class="form-footer">
                            <div class="rating-input">
                                <input type="radio" id="star5" name="rating" value="5" required><label for="star5" title="5 stars">‚òÜ</label>
                                <input type="radio" id="star4" name="rating" value="4"><label for="star4">‚òÜ</label>
                                <input type="radio" id="star3" name="rating" value="3"><label for="star3">‚òÜ</label>
                                <input type="radio" id="star2" name="rating" value="2"><label for="star2">‚òÜ</label>
                                <input type="radio" id="star1" name="rating" value="1"><label for="star1">‚òÜ</label>
                            </div>
                            <button type="submit">Post Comment</button>
                        </div>
                    </form>
                </div>
                <% } %>

                <div class="comment-list">
                    <% if(reviews && reviews.length > 0) { %>
                        <% reviews.forEach(review => { %>
                        <div class="comment-item">
                            <div class="comment-header">
                                <div class="avatar-wrapper">
                                    <img src="<%= (review.user && review.user.signedAvatarUrl) ? review.user.signedAvatarUrl : '/images/default-avatar.png' %>" alt="User Avatar">
                                </div>
                                <span class="comment-author"><%= review.username %></span>
                                <div class="comment-rating rating">
                                    <div class="stars-outer">
                                        <div class="stars-inner" style="width: <%= (review.rating / 5) * 100 %>%;"></div>
                                    </div>
                                </div>
                            </div>
                            <p class="comment-body"><%- review.comment.replace(/\n/g, '<br>') %></p>
                        </div>
                        <% }) %>
                    <% } else { %>
                        <p>No reviews yet. Be the first to leave one!</p>
                    <% } %>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- ======== ADD THE REPORT MODAL HTML BACK IN ======== -->
<div id="reportModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);">
    <div class="modal-content" style="background-color: var(--dark-gray); margin: 15% auto; padding: 2rem; border: 1px solid var(--light-grey); width: 80%; max-width: 500px; border-radius: 8px; position: relative;">
        <span class="close-modal" style="color: var(--silver); float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3>Report "<%= file.name %>"</h3>
        <form action="/files/<%= file._id %>/report" method="POST">
            <div class="form-group" style="margin-top: 1rem;">
                <label for="reason">Reason for reporting*</label>
                <select name="reason" id="reason" required style="width:100%; padding: 10px; background-color: var(--black); border: 1px solid var(--light-grey); color: var(--white); border-radius: 4px;">
                    <option value="" disabled selected>Select a reason...</option>
                    <option value="malware">Contains malware/virus</option>
                    <option value="broken-file">File is broken or does not work</option>
                    <option value="incorrect-info">Description or screenshots are incorrect</option>
                    <option value="copyright">Copyright infringement</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label for="additionalComments">Additional Comments (Optional)</label>
                <textarea name="additionalComments" id="additionalComments" style="width: 100%; min-height: 80px; padding: 10px; background-color: var(--black); border: 1px solid var(--light-grey); color: var(--white); border-radius: 4px;"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Submit Report</button>
        </form>
    </div>
</div>
<!-- ======================================================= -->


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab Functionality
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTabId = button.getAttribute('data-tab');
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(targetTabId).classList.add('active');
            });
        });

        // ======== ADD THIS MODAL JS LOGIC BACK IN ========
        const modal = document.getElementById('reportModal');
        const btn = document.getElementById('reportModalBtn');
        const span = document.querySelector('.close-modal'); // Use querySelector for classes

        if (btn) {
            btn.onclick = function() {
                if(modal) modal.style.display = 'block';
            }
        }
        if (span) {
            span.onclick = function() {
                if(modal) modal.style.display = 'none';
            }
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                if(modal) modal.style.display = 'none';
            }
        }

        // --- Optional: Show a "Thank you" message after reporting ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('reported') && urlParams.get('reported') === 'true') {
            alert('Thank you for your report. An administrator will review it shortly.');
        }
        // ==================================================
    });
</script>

<%- include('../partials/footer') %>