<%- include('../partials/header') %>    

<main>
    <div class="page-header">
        <div class="container">
            <h1>Edit <span>Your Profile</span></h1>
        </div>
    </div>
    
    <div class="container">
        <div class="edit-profile-layout">
            <!-- Profile Details Form -->
            <section class="form-section">
                <h2>Profile Details</h2>
                <form action="/account/update-profile-image" method="POST" enctype="multipart/form-data" class="avatar-section">
                    <div class="avatar-preview-wrapper">
                        <img src="<%= user.signedAvatarUrl %>" alt="Avatar Preview" class="avatar-preview" id="avatar-preview">
                        <label for="avatar-input" class="avatar-edit-button">✏️</label>
                        <input type="file" id="avatar-input" name="profileImage" accept="image/png, image/jpeg">
                    </div>
                    <!-- The button to submit the avatar is now part of its form -->
                    <button type="submit" class="submit-button secondary-button" style="margin-bottom: 20px;">Save New Avatar</button>
                </form>

                <h3 class="current-username"><%= user.username %></h3>
                <div class="profile-actions">
                    <a href="/my-uploads" class="submit-button secondary-button" style="text-align: center; text-decoration: none;">View Your Mod Upload History</a>
                    <a href="/users/<%= user.username %>" class="submit-button secondary-button" style="text-align: center; text-decoration: none;">View Your Public User Profile</a>
                </div>
                
                <hr style="border-color: #333; margin: 30px 0;">

                <form action="/account/update-details" method="POST">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" value="<%= user.username %>" required>
                    </div>
                    <div class="form-group">
                        <label for="bio">Your Bio</label>
                        <textarea id="bio" name="bio" placeholder="Tell us a little about yourself..."><%= user.bio || '' %></textarea>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" value="<%= user.email %>" required>
                         <p class="email-note">Note: Changing your email will require re-verification and you will be logged out.</p>
                    </div>
                    <button type="submit" class="submit-button">Save Profile Changes</button>
                </form>
            </section>

            <!-- Change Password Form -->
            <section class="form-section">
                <h2>Change Password</h2>
                <form action="/account/change-password" method="POST">
                    <div class="form-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" name="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" name="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirm New Password</label>
                        <input type="password" id="confirm-password" name="confirmPassword" required>
                    </div>
                    <button type="submit" class="submit-button secondary-button">Update Password</button>
                </form>
            </section>

            <!-- Danger Zone for Deleting Account -->
            <section class="form-section danger-zone">
                <h2>Danger Zone</h2>
                <p>Deleting your account is a permanent action. All of your uploaded mods, comments, and personal data will be removed forever. This action cannot be undone.</p>
                <form action="/account/delete" method="POST">
                    <div class="checkbox-group">
                        <input type="checkbox" id="preserve-mods" name="preserveMods" value="true">
                        <label for="preserve-mods">Preserve my uploaded mods.</label>
                    </div>
                     <p>If checked, your uploads will remain on the site and the author will be changed to "GPL Community". Otherwise, all your uploads will be deleted with your account.</p>
                    <button type="submit" class="submit-button delete-button" id="delete-account-btn">Delete My Account</button>
                </form>
            </section>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Live Avatar Preview Logic ---
        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');
        avatarInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { avatarPreview.src = e.target.result; }
                reader.readAsDataURL(this.files[0]);
            }
        });

        // --- Delete Account Confirmation ---
        const deleteForm = document.querySelector('form[action="/account/delete"]');
        if (deleteForm) {
            deleteForm.addEventListener('submit', function(e) {
                const confirmation = confirm('Are you absolutely sure you want to delete your account? This is permanent.');
                if (!confirmation) {
                    e.preventDefault(); // Stop the form from submitting if user cancels
                }
            });
        }
    });
</script>
<%- include('../partials/footer') %>