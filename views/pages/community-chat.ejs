<%- include('../partials/header') %>
<style>
    body { display: flex; flex-direction: column; height: 100vh; margin:0; }
    main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; padding-bottom: 70px; }
    #messages { list-style-type: none; margin: 0; padding: 20px; overflow-y: auto; flex-grow: 1; }
    #messages li { padding: 10px 15px; display: flex; align-items: flex-start; gap: 15px; border-radius: 8px; }
    #messages li:not(:last-child) { margin-bottom: 5px; }
    #messages li:nth-child(odd) { background-color: var(--dark-gray); }
    #messages .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    #messages .message-content { display: flex; flex-direction: column; }
    #messages .message-header { display: flex; align-items: center; gap: 10px; margin-bottom: 3px; }
    #messages .username { font-weight: bold; color: var(--gold); }
    #messages .timestamp { font-size: 0.8em; color: var(--silver); }
    #chat-form { position: fixed; bottom: 0; left: 0; right: 0; display: flex; padding: 10px; background-color: var(--dark-gray); border-top: 1px solid #333; }
    #input { border: 1px solid #333; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin-right: 10px; background: var(--black); color:var(--white); }
    .btn-primary { background: var(--gold); color: var(--black); border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
</style>

<main class="container">
    <h2 style="margin-top: 1rem; text-align:center;">Community Chat</h2>
    <ul id="messages"></ul> <!-- This will be populated by JavaScript -->
</main>

<form id="chat-form" action="">
    <input id="input" autocomplete="off" placeholder="Type a message..." /><button type="submit" class="btn-primary">Send</button>
</form>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const form = document.getElementById('chat-form');
    const input = document.getElementById('input');
    const messages = document.getElementById('messages');
    const currentUser = {
        username: '<%= user.username %>',
        avatar: '<%= user.signedAvatarUrl || "/images/default-avatar.png" %>'
    };

    // --- Function to create and append a message element ---
    function appendMessage(msg) {
        const item = document.createElement('li');
        
        const avatarImg = document.createElement('img');
        avatarImg.src = msg.avatar;
        avatarImg.className = 'avatar';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';

        const usernameSpan = document.createElement('span');
        usernameSpan.className = 'username';
        usernameSpan.textContent = msg.username;

        const timestampSpan = document.createElement('span');
        timestampSpan.className = 'timestamp';
        // Format the timestamp to be readable
        timestampSpan.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        const textNode = document.createElement('span');
        textNode.textContent = msg.text;

        headerDiv.appendChild(usernameSpan);
        headerDiv.appendChild(timestampSpan);
        contentDiv.appendChild(headerDiv);
        contentDiv.appendChild(textNode);
        
        item.appendChild(avatarImg);
        item.appendChild(contentDiv);

        messages.appendChild(item);
        // Auto-scroll to the bottom
        messages.scrollTop = messages.scrollHeight;
    }

    // --- Handle Form Submission ---
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
            socket.emit('chat message', {
                username: currentUser.username,
                avatar: currentUser.avatar,
                text: input.value
            });
            input.value = '';
        }
    });
    
    // --- NEW: Listen for message history on connection ---
    socket.on('chat history', function(history) {
        // Clear any existing messages first
        messages.innerHTML = '';
        // Append all messages from history
        history.forEach(msg => {
            appendMessage(msg);
        });
    });

    // --- Listen for new incoming messages ---
    socket.on('chat message', function(msg) {
        appendMessage(msg);
    });
</script>

</body>
</html>