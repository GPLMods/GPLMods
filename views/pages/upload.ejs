<%- include('../partials/header') %>
<style>
    .upload-container { max-width: 700px; margin: 2rem auto; padding: 2rem; background-color: var(--dark-gray); border-radius: 8px; text-align: center; }
    #drop-area { border: 2px dashed var(--silver); border-radius: 8px; padding: 40px; margin-bottom: 20px; transition: all 0.3s ease; }
    #drop-area.highlight { border-color: var(--gold); background-color: #333; }
    #file-input { display: none; }
    #progress-bar-container { display: none; }
    #progress-bar { width: 100%; height: 25px; background-color: var(--black); border-radius: 5px; overflow: hidden; }
    #progress-bar-fill { width: 0%; height: 100%; background-color: var(--gold); transition: width 0.3s ease; }
    #upload-status { margin-top: 10px; color: var(--silver); }
</style>

<div class="container">
    <div class="upload-container">
        <h2>Upload Your Mod File</h2>
        <p>Step 1 of 2: Select or drag & drop your mod file (.zip, .rar, .exe, etc.).</p>
        
        <div id="drop-area">
            <p>Drag your file here, or <a href="#" id="browse-link">browse your computer</a>.</p>
            <input type="file" id="file-input">
        </div>

        <div id="progress-bar-container">
            <p id="file-name-display"></p>
            <div id="progress-bar"><div id="progress-bar-fill"></div></div>
            <p id="upload-status">Initializing upload...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const browseLink = document.getElementById('browse-link');
    const progressBarContainer = document.getElementById('progress-bar-container');
    const progressBarFill = document.getElementById('progress-bar-fill');
    const uploadStatus = document.getElementById('upload-status');
    const fileNameDisplay = document.getElementById('file-name-display');

    // --- Drag & Drop Event Handlers ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        });
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'));
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'));
    });
    dropArea.addEventListener('drop', e => {
        handleFiles(e.dataTransfer.files);
    });

    // --- Click to Browse ---
    browseLink.addEventListener('click', e => {
        e.preventDefault();
        fileInput.click();
    });
    fileInput.addEventListener('change', () => {
        handleFiles(fileInput.files);
    });

    // --- Main Upload Logic ---
    async function handleFiles(files) {
        if (files.length === 0) return;
        const file = files[0];
        
        // --- Show the progress bar ---
        fileNameDisplay.textContent = `Uploading: ${file.name}`;
        progressBarContainer.style.display = 'block';
        dropArea.style.display = 'none';

        try {
            // --- STEP 1: Ask our server for a presigned URL ---
            uploadStatus.textContent = 'Preparing secure upload...';
            const response = await fetch('/generate-presigned-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, filetype: file.type, folder: 'mods' })
            });

            if (!response.ok) throw new Error('Could not prepare upload. Server error.');
            
            const { presignedUrl, fileKey } = await response.json();

            // --- STEP 2: Upload directly to B2 using the presigned URL ---
            uploadStatus.textContent = 'Uploading... 0%';
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', presignedUrl, true);
            xhr.setRequestHeader('Content-Type', file.type);
            
            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    progressBarFill.style.width = percentComplete + '%';
                    uploadStatus.textContent = `Uploading... ${percentComplete}%`;
                }
            };
            
            xhr.onload = () => {
                if (xhr.status === 200) {
                    uploadStatus.textContent = 'Upload Complete! Redirecting...';
                    // --- STEP 3: Redirect to the metadata form on success ---
                    window.location.href = `/upload-details?fileKey=${encodeURIComponent(fileKey)}&filename=${encodeURIComponent(file.name)}&filesize=${file.size}`;
                } else {
                    throw new Error(`Upload failed with status: ${xhr.status}`);
                }
            };
            
            xhr.onerror = () => {
                throw new Error('Upload failed. Network error.');
            };

            xhr.send(file);

        } catch (error) {
            console.error('Upload process failed:', error);
            uploadStatus.textContent = `Error: ${error.message}`;
            uploadStatus.style.color = '#ff4d4d';
        }
    }
});
</script>

<%- include('../partials/footer') %>